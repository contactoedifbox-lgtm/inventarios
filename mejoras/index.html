<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control - Inventario y Ventas (MEJORAS)</title>
    
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Nuestros estilos separados -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/auth.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/modal.css">
    <link rel="stylesheet" href="css/tables.css">
    <link rel="stylesheet" href="css/utilities.css">
    
    <!-- Supabase JS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- ========== LOGIN CONTAINER ========== -->
    <div id="login-container">
        <div class="login-box">
            <h2><i class="fas fa-lock"></i> Acceso Cliente (MEJORAS)</h2>
            <p style="color: #64748b; margin-bottom: 20px;">Ingresa tus credenciales para acceder al panel de mejoras</p>
            
            <div id="login-error" class="error">
                Credenciales incorrectas. Intenta nuevamente.
            </div>
            
            <input type="email" id="login-email" placeholder="Correo electr贸nico">
            <input type="password" id="login-password" placeholder="Contrase帽a">
            
            <button id="login-button">
                <i class="fas fa-sign-in-alt"></i> Iniciar Sesi贸n
            </button>
            
            <div style="margin-top: 20px; padding: 15px; background: #f8fafc; border-radius: 8px; font-size: 14px;">
                <p><i class="fas fa-info-circle"></i> <strong>Sistema Veterinario - Acceso Restringido</strong></p>
                <p style="font-size: 12px; color: #64748b;">Solo personal autorizado</p>
            </div>
        </div>
    </div>
    
    <!-- ========== APP CONTAINER (oculto hasta login) ========== -->
    <div id="app-container" class="app-container">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <div>
                    <h1><i class="fas fa-warehouse"></i> Sistema de Inventario y Ventas</h1>
                    <p class="subtitle">Panel de administraci贸n - <span id="current-user"></span> </p>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div>
                        <button id="agregar-venta-btn" style="padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; margin-right: 10px;">
                            <i class="fas fa-plus-circle"></i> Agregar Venta
                        </button>
                        <button id="exportar-excel-btn" style="padding: 10px 20px; background: var(--success); color: white; border: none; border-radius: 8px; cursor: pointer; margin-right: 10px;">
                            <i class="fas fa-file-excel"></i> Exportar a Excel
                        </button>
                        <button id="reporte-encargos-btn" style="padding: 10px 20px; background: #f59e0b; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            <i class="fas fa-clipboard-list"></i> Encargos Pendientes
                        </button>
                    </div>
                    <div class="user-info">
                        <i class="fas fa-user-circle"></i>
                        <span id="user-email"></span>
                    </div>
                    <button class="logout-btn" id="logout-button">
                        <i class="fas fa-sign-out-alt"></i> Salir
                    </button>
                </div>
            </div>
            
            <!-- Stats Cards -->
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-icon icon-inventory">
                        <i class="fas fa-boxes"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Productos en Inventario</h3>
                        <div class="stat-value" id="total-productos">0</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon icon-sales">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Total Ventas Hoy</h3>
                        <div class="stat-value" id="ventas-hoy">$0</div>
                        <div class="hora-chile" id="fecha-hoy"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #f3e8ff; color: #8b5cf6;">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Stock Bajo (< 10)</h3>
                        <div class="stat-value" id="stock-bajo">0</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #ffe4e6; color: #f43f5e;">
                        <i class="fas fa-sync-alt"></i>
                    </div>
                    <div class="stat-info">
                        <h3>ltima Actualizaci贸n</h3>
                        <div class="stat-value" id="ultima-actualizacion">--:--</div>
                        <div class="hora-chile">Hora Chile</div>
                    </div>
                </div>
            </div>
            
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn" id="tab-ventas-btn">
                    <i class="fas fa-shopping-cart"></i> Ventas
                </button>    
                <button class="tab-btn active" id="tab-inventario-btn">
                    <i class="fas fa-boxes"></i> Inventario
                </button>
            </div>
            
            <!-- Search -->
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Buscar por c贸digo de barras o descripci贸n...">
            </div>

            <!-- Ventas Tab -->
            <div id="tab-ventas" class="tab-content active">
                <div class="table-container">
                    <table id="tablaVentas">
                        <thead>
                            <tr>
                                <th>C贸digo de Barras</th>
                                <th>Cantidad</th>
                                <th>Precio Unitario</th>
                                <th>Descuento</th>
                                <th>Total</th>
                                <th>Descripci贸n</th>
                                <th>Fecha Venta (Chile)</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="ventasBody">
                            <!-- Los datos se cargar谩n aqu铆 -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Inventario Tab -->
            <div id="tab-inventario" class="tab-content">
                <div class="table-container">
                    <table id="tablaInventario">
                        <thead>
                            <tr>
                                <th>C贸digo de Barras</th>
                                <th>Descripci贸n</th>
                                <th>Cantidad</th>
                                <th>Costo</th>
                                <th>Precio Venta</th>
                                <th>ltima Actualizaci贸n</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="inventarioBody">
                            <!-- Los datos se cargar谩n aqu铆 -->
                        </tbody>
                    </table>
                </div>
            </div>
            
        </div>
        
        <!-- Modal Editar Inventario -->
        <div id="modalInventario" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Editar Producto (MEJORAS)</h2>
                    <button id="close-modal-inventario" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #64748b;"></button>
                </div>
                <div class="modal-body">
                    <form id="formInventario">
                        <div class="form-group">
                            <label>C贸digo de Barras</label>
                            <input type="text" id="editCodigo" readonly style="background: #f1f5f9;">
                        </div>
                        <div class="form-group">
                            <label>Descripci贸n</label>
                            <textarea id="editDescripcion" rows="3"></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Cantidad</label>
                                <input type="number" id="editCantidad" min="0" required>
                            </div>
                            <div class="form-group">
                                <label>Costo</label>
                                <input type="number" id="editCosto" min="0" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label>Precio Venta</label>
                                <input type="number" id="editPrecio" min="0" step="0.01" required>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="action-btn btn-cancel" id="cancel-inventario">Cancelar</button>
                    <button class="action-btn btn-save" id="save-inventario">Guardar Cambios</button>
                </div>
            </div>
        </div>
        
        <!-- Modal Editar Venta -->
        <div id="modalVenta" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Editar Cantidad de Venta (MEJORAS)</h2>
                    <button id="close-modal-venta" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #64748b;"></button>
                </div>
                <div class="modal-body">
                    <form id="formVenta">
                        <div class="form-group">
                            <label>C贸digo de Barras</label>
                            <input type="text" id="editVentaCodigo" readonly style="background: #f1f5f9;">
                        </div>
                        <div class="form-group">
                            <label>Fecha de Venta</label>
                            <input type="text" id="editVentaFecha" readonly style="background: #f1f5f9;">
                        </div>
                        <div class="form-group">
                            <label>Descripci贸n</label>
                            <input type="text" id="editVentaDescripcion" readonly style="background: #f1f5f9;">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Precio Unitario</label>
                                <input type="text" id="editVentaPrecio" readonly style="background: #f1f5f9;">
                            </div>
                            <div class="form-group">
                                <label>Descuento Actual ($)</label>
                                <input type="number" id="editVentaDescuento" step="0.01" min="0" required>
                                <small style="color: #64748b; font-size: 12px;">Modificar si es necesario</small>
                            </div>
                            <div class="form-group">
                                <label>Nueva Cantidad</label>
                                <input type="number" id="editVentaCantidad" min="1" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Nuevo Total</label>
                            <input type="text" id="editVentaTotal" readonly style="background: #f1f5f9; font-weight: bold; font-size: 18px;">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="action-btn btn-cancel" id="cancel-venta">Cancelar</button>
                    <button class="action-btn btn-save" id="save-venta">Actualizar Venta</button>
                </div>
            </div>
        </div>
        
        <!-- Modal Agregar Venta -->
        <div id="modalAgregarVenta" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Agregar Venta Manual (MEJORAS)</h2>
                    <button id="close-modal-agregar-venta" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #64748b;"></button>
                </div>
                <div class="modal-body">
                    <form id="formAgregarVenta">
                        <div class="form-group">
                            <label>Buscar Producto</label>
                            <input type="text" id="buscarProducto" placeholder="Escribe c贸digo o descripci贸n..." 
                                   style="padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; width: 100%;">
                            <div id="resultadosBusqueda" style="max-height: 200px; overflow-y: auto; margin-top: 10px; border: 1px solid #e2e8f0; border-radius: 8px; display: none;">
                                <!-- Resultados aparecen aqu铆 -->
                            </div>
                        </div>
                        
                        <div class="form-group" id="infoProducto" style="display: none;">
                            <div style="background: #f8fafc; padding: 15px; border-radius: 8px;">
                                <p><strong>Producto seleccionado:</strong> <span id="productoNombre"></span></p>
                                <p><strong>C贸digo:</strong> <span id="productoCodigo"></span></p>
                                <p><strong>Stock disponible:</strong> <span id="productoStock"></span></p>
                                <p><strong>Precio actual:</strong> $<span id="productoPrecio"></span></p>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Cantidad</label>
                                <input type="number" id="ventaCantidad" min="1" value="1" required>
                            </div>
                            <div class="form-group">
                                <label>Precio Unitario</label>
                                <input type="number" id="ventaPrecio" step="0.01" min="0" required>
                            </div>
                            <div class="form-group">
                                <label>Descuento ($)</label>
                                <input type="number" id="ventaDescuento" step="0.01" min="0" value="0" required>
                                <small style="color: #64748b; font-size: 12px;">Monto fijo en pesos</small>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Descripci贸n de la Venta</label>
                            <textarea id="ventaDescripcion" rows="2" placeholder="Descripci贸n del producto..."></textarea>
                            <small style="color: #64748b; font-size: 12px;">Puedes modificar esta descripci贸n si es necesario</small>
                        </div>
                        
                        <div class="form-group" style="background: #fffbeb; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                            <p><strong>Total a registrar:</strong> <span id="ventaTotal" style="font-size: 20px; font-weight: bold; color: #1e293b;">$0.00</span></p>
                            <p style="color: #64748b; font-size: 12px; margin-top: 5px;">Fecha: <span id="fechaVentaActual">Cargando...</span> (Hora Chile)</p>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="action-btn btn-cancel" id="cancel-agregar-venta">Cancelar</button>
                    <button class="action-btn btn-save" id="save-agregar-venta">Registrar Venta</button>
                </div>
            </div>
        </div>

        <!-- ========== MODAL PARA ENCARGOS PENDIENTES ========== -->
        <div id="modalEncargos" class="modal">
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h2><i class="fas fa-clipboard-list"></i> Reporte de Encargos Pendientes (MEJORAS)</h2>
                    <button id="close-modal-encargos" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #64748b;"></button>
                </div>
                <div class="modal-body">
                    <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="color: #475569; margin-bottom: 5px;">Productos con stock negativo (encargos)</h3>
                            <p style="color: #64748b; font-size: 14px;">Total de encargos pendientes: <strong id="total-encargos">0</strong></p>
                        </div>
                    </div>
                    
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8fafc;">
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0; color: #475569;">C贸digo</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0; color: #475569;">Descripci贸n</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0; color: #475569;">Cantidad Pendiente</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0; color: #475569;">Costo</th>
                                </tr>
                            </thead>
                            <tbody id="lista-encargos">
                                <!-- Los encargos se cargar谩n aqu铆 -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid var(--primary);">
                        <h4 style="color: #0369a1; margin-bottom: 10px;"><i class="fas fa-info-circle"></i> Instrucciones:</h4>
                        <ul style="color: #475569; font-size: 14px; padding-left: 20px;">
                            <li>Los productos con cantidad negativa representan encargos pendientes</li>
                            <li>Valores como <strong>-1, -3</strong> indican que hay 1 o 3 unidades encargadas</li>
                            <li>Para reponer stock, usa la funci贸n normal de "Editar" en el inventario</li>
                            <li>Exporta el reporte para enviarlo a tu proveedor</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="action-btn btn-cancel" id="cancel-encargos">Cerrar</button>
                </div>
            </div>
        </div>
        
        <!-- Notificaci贸n -->
        <div id="notification" class="notification"></div>
        
        <!-- Badge offline -->
        <div id="offlineBadge" class="offline-badge">
             <span id="offlineCount">0</span> venta(s) pendientes
        </div>
    </div>

    <!-- ========== SCRIPTS ========== -->
    <!-- Configuraci贸n -->
    <script src="js/config/supabase-config.js"></script>
    
    <!-- M贸dulos principales -->
    <script src="js/modules/utils.js"></script>
    <script src="js/modules/auth.js"></script>
    <script src="js/modules/inventory.js"></script>
    <script src="js/modules/sales.js"></script>
    <script src="js/modules/sync.js"></script>
    
    <!-- UI Components -->
    <script src="js/ui/modal-manager.js"></script>
    <script src="js/ui/table-renderer.js"></script>
    <script src="js/ui/notifications.js"></script>
    <script src="js/ui/search-manager.js"></script>
    
    <!-- Aplicaci贸n principal -->
    <script src="js/app.js"></script>
</body>
</html>
