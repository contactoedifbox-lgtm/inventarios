<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control - Inventario y Ventas Veterinaria</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Nuestros archivos CSS -->
    <link rel="stylesheet" href="css/login.css">
    <link rel="stylesheet" href="css/style.css">
    
    <!-- Preload para mejor performance -->
    <link rel="preconnect" href="https://qnhmfvtqgwtlckcvzbhq.supabase.co">
</head>
<body>
    <!-- ========== LOGIN CONTAINER ========== -->
    <div id="login-container">
        <div class="login-box">
            <h2><i class="fas fa-lock"></i> Acceso Sistema Veterinaria</h2>
            <p class="login-subtitle">Ingresa tus credenciales para acceder al panel</p>
            
            <div class="login-error">
                Credenciales incorrectas. Intenta nuevamente.
            </div>
            
            <div class="login-loading">
                <i class="fas fa-spinner"></i> Verificando...
            </div>
            
            <input type="email" id="login-email" placeholder="Correo electr贸nico" autocomplete="username">
            <input type="password" id="login-password" placeholder="Contrase帽a" autocomplete="current-password">
            
            <button id="login-button">
                <i class="fas fa-sign-in-alt"></i> Iniciar Sesi贸n
            </button>
            
            <div class="login-info">
                <p><i class="fas fa-info-circle"></i> <strong>Sistema Veterinario - Acceso Restringido</strong></p>
                <p>Panel de administraci贸n - Solo personal autorizado</p>
            </div>
        </div>
    </div>
    
    <!-- ========== APP CONTAINER (oculto hasta login) ========== -->
    <div id="app-container" class="app-container">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <div>
                    <h1><i class="fas fa-warehouse"></i> Sistema de Inventario y Ventas Veterinaria</h1>
                    <p class="subtitle">Panel de administraci贸n - <span id="current-user"></span></p>
                </div>
                <div class="header-buttons">
                    <button id="recarga-inventario-btn" class="header-btn warning">
                        <i class="fas fa-sync-alt"></i> Recargar Inventario
                    </button>
                <div id="sincronizacion-indicador" class="sync-indicator sync-success">
                    <i class="fas fa-check-circle"></i> Inventario completo
                </div>
                    <button id="agregar-venta-btn" class="header-btn primary">
                        <i class="fas fa-plus-circle"></i> Agregar Venta
                    </button>
                    <button id="agregar-venta-multiple-btn" class="header-btn success">
                        <i class="fas fa-cart-plus"></i> Venta M煤ltiple
                    </button>
                    <button id="exportar-excel-btn" class="header-btn success">
                        <i class="fas fa-file-excel"></i> Exportar a Excel
                    </button>
                    <button id="reporte-encargos-btn" class="header-btn warning">
                        <i class="fas fa-clipboard-list"></i> Encargos Pendientes
                    </button>
                    <div class="user-info">
                        <i class="fas fa-user-circle"></i>
                        <span id="user-email"></span>
                    </div>
                    <button class="logout-btn" id="logout-button">
                        <i class="fas fa-sign-out-alt"></i> Salir
                    </button>
                </div>
            </div>
            
            <!-- Stats Cards -->
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-icon icon-inventory">
                        <i class="fas fa-boxes"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Productos en Inventario</h3>
                        <div class="stat-value" id="total-productos">0</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon icon-sales">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Total Ventas Hoy</h3>
                        <div class="stat-value" id="ventas-hoy">$0</div>
                        <div class="hora-chile" id="fecha-hoy"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon icon-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Stock Bajo (< 10)</h3>
                        <div class="stat-value" id="stock-bajo">0</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon icon-update">
                        <i class="fas fa-sync-alt"></i>
                    </div>
                    <div class="stat-info">
                        <h3>ltima Actualizaci贸n</h3>
                        <div class="stat-value" id="ultima-actualizacion">--:--</div>
                        <div class="hora-chile">Hora Chile</div>
                    </div>
                </div>
            </div>
            
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn active" id="tab-ventas-btn">
                    <i class="fas fa-shopping-cart"></i> Ventas
                </button>    
                <button class="tab-btn" id="tab-inventario-btn">
                    <i class="fas fa-boxes"></i> Inventario
                </button>
            </div>
            
            <!-- Search -->
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Buscar por c贸digo de barras o descripci贸n..." autocomplete="off">
            </div>

            <!-- Ventas Tab -->
            <div id="tab-ventas" class="tab-content active">
                <div class="table-container">
                    <table id="tablaVentas">
                        <thead>
                            <tr>
                                <th>C贸digo de Barras</th>
                                <th>Cantidad</th>
                                <th>Precio Unitario</th>
                                <th>Descuento</th>
                                <th>Total</th>
                                <th>Descripcion</th>
                                <th>Fecha Venta (Chile)</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="ventasBody">
                            <!-- Los datos se cargar谩n aqu铆 -->
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 40px; color: #64748b;">
                                    <i class="fas fa-spinner fa-spin"></i> Cargando ventas...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Inventario Tab -->
            <div id="tab-inventario" class="tab-content">
                <div class="table-container">
                    <table id="tablaInventario">
                        <thead>
                            <tr>
                                <th>C贸digo de Barras</th>
                                <th>Descripcion</th>
                                <th>Cantidad</th>
                                <th>Costo</th>
                                <th>Precio Venta</th>
                                <th>ltima Actualizaci贸n</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="inventarioBody">
                            <!-- Los datos se cargar谩n aqu铆 -->
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px; color: #64748b;">
                                    <i class="fas fa-spinner fa-spin"></i> Cargando inventario...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
        </div>
        
        <!-- Modal Editar Inventario -->
        <div id="modalInventario" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Editar Producto</h2>
                    <button class="modal-close"></button>
                </div>
                <div class="modal-body">
                    <form id="formInventario">
                        <div class="form-group">
                            <label>C贸digo de Barras</label>
                            <input type="text" id="editCodigo" readonly class="readonly-input">
                        </div>
                        <div class="form-group">
                            <label>Descripcion</label>
                            <textarea id="editDescripcion" rows="3"></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Cantidad</label>
                                <input type="number" id="editCantidad" min="0" required>
                            </div>
                            <div class="form-group">
                                <label>Costo</label>
                                <input type="number" id="editCosto" min="0" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label>Precio Venta</label>
                                <input type="number" id="editPrecio" min="0" step="0.01" required>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="action-btn btn-cancel">Cancelar</button>
                    <button class="action-btn btn-save" id="save-inventario">Guardar Cambios</button>
                </div>
            </div>
        </div>
        
        <!-- Modal Editar Venta -->
        <div id="modalVenta" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Editar Venta</h2>
                    <button class="modal-close"></button>
                </div>
                <div class="modal-body">
                    <form id="formVenta">
                        <div class="form-group">
                            <label>C贸digo de Barras</label>
                            <input type="text" id="editVentaCodigo" readonly class="readonly-input">
                        </div>
                        <div class="form-group">
                            <label>Fecha de Venta</label>
                            <input type="text" id="editVentaFecha" readonly class="readonly-input">
                        </div>
                        <div class="form-group">
                            <label>Descripcion</label>
                            <input type="text" id="editVentaDescripcion" class="readonly-input">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Precio Unitario</label>
                                <input type="number" id="editVentaPrecio" step="0.01" min="0" required>
                            </div>
                            <div class="form-group">
                                <label>Descuento ($)</label>
                                <input type="number" id="editVentaDescuento" step="0.01" min="0" required>
                                <small class="form-help">Modificar si es necesario</small>
                            </div>
                            <div class="form-group">
                                <label>Nueva Cantidad</label>
                                <input type="number" id="editVentaCantidad" min="1" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Nuevo Total</label>
                            <input type="text" id="editVentaTotal" readonly class="readonly-input total-display">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="action-btn btn-cancel">Cancelar</button>
                    <button class="action-btn btn-save" id="save-venta">Actualizar Venta</button>
                </div>
            </div>
        </div>
        
        <!-- Modal Agregar Venta -->
        <div id="modalAgregarVenta" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Agregar Venta Manual</h2>
                    <button class="modal-close"></button>
                </div>
                <div class="modal-body">
                    <form id="formAgregarVenta">
                        <div class="form-group">
                            <label>Buscar Producto</label>
                            <input type="text" id="buscarProducto" placeholder="Escribe c贸digo o descripci贸n..." 
                                   class="search-product-input" autocomplete="off">
                            <div id="resultadosBusqueda" class="search-results">
                                <!-- Resultados aparecen aqu铆 -->
                            </div>
                        </div>
                        
                        <div class="form-group" id="infoProducto">
                            <div class="product-info">
                                <p><strong>Producto seleccionado:</strong> <span id="productoNombre"></span></p>
                                <p><strong>C贸digo:</strong> <span id="productoCodigo"></span></p>
                                <p><strong>Stock disponible:</strong> <span id="productoStock"></span></p>
                                <p><strong>Precio actual:</strong> $<span id="productoPrecio"></span></p>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Cantidad</label>
                                <input type="number" id="ventaCantidad" min="1" value="1" required>
                            </div>
                            <div class="form-group">
                                <label>Precio Unitario</label>
                                <input type="number" id="ventaPrecio" step="0.01" min="0" required>
                            </div>
                            <div class="form-group">
                                <label>Descuento ($)</label>
                                <input type="number" id="ventaDescuento" step="0.01" min="0" value="0" required>
                                <small class="form-help">Monto fijo en pesos</small>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Descripcion de la Venta</label>
                            <textarea id="ventaDescripcion" rows="2" placeholder="Descripci贸n del producto..."></textarea>
                            <small class="form-help">Puedes modificar esta descripci贸n si es necesario</small>
                        </div>
                        
                        <div class="form-group venta-total-info">
                            <p><strong>Total a registrar:</strong> <span id="ventaTotal" class="venta-total">$0.00</span></p>
                            <p class="venta-fecha">Fecha: <span id="fechaVentaActual">Cargando...</span> (Hora Chile)</p>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="action-btn btn-cancel">Cancelar</button>
                    <button class="action-btn btn-save" id="save-agregar-venta">Registrar Venta</button>
                </div>
            </div>
        </div>
    </div> <!-- CIERRA app-container -->

    <!-- ========== MODAL PARA VENTAS MLTIPLES ========== -->
    <div id="modalVentaMultiple" class="modal">
        <div class="modal-content modal-wide">
            <div class="modal-header">
                <h2><i class="fas fa-cart-plus"></i> Venta M煤ltiple</h2>
                <button class="modal-close"></button>
            </div>
            <div class="modal-body">
                <!-- Contador de l铆neas -->
                <div class="venta-multiple-header">
                    <div class="venta-counter">
                        <i class="fas fa-list-ol"></i>
                        <span id="contador-lineas">1</span> producto(s) en la venta
                    </div>
                    <button id="agregar-linea-btn" class="action-btn btn-edit">
                        <i class="fas fa-plus"></i> Agregar otro producto
                    </button>
                </div>
                
                <!-- Contenedor de l铆neas din谩micas -->
                <div id="lineas-venta-container">
                    <!-- Las l铆neas se agregar谩n din谩micamente aqu铆 -->
                    <!-- L铆nea 1 (inicial) -->
                    <div class="venta-linea" data-linea-id="1">
                        <div class="linea-header">
                            <span class="linea-numero">Producto 1</span>
                            <button class="linea-remove-btn" data-linea="1" style="display: none;">
                                <i class="fas fa-times"></i> Quitar
                            </button>
                        </div>
                        
                        <div class="linea-body">
                            <!-- B煤squeda de producto -->
                            <div class="form-group">
                                <label>Buscar Producto</label>
                                <div class="search-wrapper">
                                    <input type="text" 
                                           class="search-product-input linea-busqueda" 
                                           data-linea="1"
                                           placeholder="Escribe c贸digo o descripci贸n..." 
                                           autocomplete="off">
                                    <div class="search-results-linea" data-linea="1"></div>
                                </div>
                            </div>
                            
                            <!-- Informaci贸n del producto seleccionado -->
                            <div class="producto-info-linea" data-linea="1" style="display: none;">
                                <div class="producto-selected">
                                    <p><strong>Producto:</strong> <span class="producto-nombre"></span></p>
                                    <p><strong>C贸digo:</strong> <span class="producto-codigo"></span></p>
                                    <p><strong>Stock disponible:</strong> <span class="producto-stock"></span></p>
                                    <p><strong>Precio actual:</strong> $<span class="producto-precio"></span></p>
                                </div>
                            </div>
                            
                            <!-- Campos de la venta -->
                            <div class="linea-fields">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Cantidad</label>
                                        <input type="number" 
                                               class="linea-cantidad" 
                                               data-linea="1" 
                                               min="1" 
                                               value="1" 
                                               required>
                                    </div>
                                    <div class="form-group">
                                        <label>Precio Unitario</label>
                                        <input type="number" 
                                               class="linea-precio" 
                                               data-linea="1" 
                                               step="0.01" 
                                               min="0" 
                                               required>
                                    </div>
                                    <div class="form-group">
                                        <label>Descuento ($)</label>
                                        <input type="number" 
                                               class="linea-descuento" 
                                               data-linea="1" 
                                               step="0.01" 
                                               min="0" 
                                               value="0" 
                                               required>
                                        <small class="form-help">Monto fijo en pesos</small>
                                    </div>
                                    <div class="form-group">
                                        <label>Subtotal</label>
                                        <input type="text" 
                                               class="linea-subtotal readonly-input" 
                                               data-linea="1" 
                                               value="$0.00" 
                                               readonly>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label>Descripcion (opcional)</label>
                                    <textarea class="linea-descripcion" 
                                              data-linea="1" 
                                              rows="2" 
                                              placeholder="Descripci贸n adicional..."></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <div class="linea-separator"></div>
                    </div>
                    <!-- Fin L铆nea 1 -->
                </div>
                
                <!-- Resumen de la venta -->
                <div class="venta-resumen">
                    <div class="resumen-header">
                        <h3><i class="fas fa-receipt"></i> Resumen de la Venta</h3>
                    </div>
                    
                    <div class="resumen-body">
                        <div class="resumen-row">
                            <span>Subtotal:</span>
                            <span id="resumen-subtotal">$0.00</span>
                        </div>
                        <div class="resumen-row">
                            <span>Descuento Total:</span>
                            <span id="resumen-descuento">$0.00</span>
                        </div>
                        <div class="resumen-row total">
                            <span><strong>TOTAL:</strong></span>
                            <span id="resumen-total"><strong>$0.00</strong></span>
                        </div>
                    </div>
                    
                    <div class="resumen-footer">
                        <div class="fecha-venta">
                            <i class="far fa-calendar"></i>
                            <span id="fecha-venta-multiple">Cargando fecha...</span>
                        </div>
                        <div class="productos-count">
                            <i class="fas fa-box"></i>
                            <span id="total-productos-venta">0</span> productos distintos
                        </div>
                    </div>
                </div>
                
                <!-- Panel de observaciones -->
                <div class="observaciones-panel">
                    <div class="form-group">
                        <label><i class="fas fa-sticky-note"></i> Observaciones de la venta</label>
                        <textarea id="observaciones-venta" 
                                  rows="2" 
                                  placeholder="Observaciones adicionales (cliente, motivo, etc.)..."></textarea>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="action-btn btn-cancel">Cancelar</button>
                <button class="action-btn btn-success" id="registrar-venta-multiple">
                    <i class="fas fa-check-circle"></i> Registrar Venta Completa
                </button>
            </div>
        </div>
    </div>

    <!-- ========== MODAL PARA ENCARGOS PENDIENTES ========== -->
    <div id="modalEncargos" class="modal">
        <div class="modal-content modal-wide">
            <div class="modal-header">
                <h2><i class="fas fa-clipboard-list"></i> Reporte de Encargos Pendientes</h2>
                <button class="modal-close"></button>
            </div>
            <div class="modal-body">
                <div class="modal-header-info">
                    <div>
                        <h3>Productos con stock negativo (encargos)</h3>
                        <p>Total de encargos pendientes: <strong id="total-encargos">0</strong></p>
                    </div>
                </div>
                
                <div class="table-scroll">
                    <table class="encargos-table">
                        <thead>
                            <tr>
                                <th>C贸digo</th>
                                <th>Descripcion</th>
                                <th>Cantidad Pendiente</th>
                                <th>Costo</th>
                            </tr>
                        </thead>
                        <tbody id="lista-encargos">
                            <!-- Los encargos se cargar谩n aqu铆 -->
                            <tr>
                                <td colspan="4" style="text-align: center; padding: 40px; color: #64748b;">
                                    No hay encargos pendientes
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="info-box">
                    <h4><i class="fas fa-info-circle"></i> Instrucciones:</h4>
                    <ul>
                        <li>Los productos con cantidad negativa representan encargos pendientes</li>
                        <li>Valores como <strong>-1, -3</strong> indican que hay 1 o 3 unidades encargadas</li>
                        <li>Para reponer stock, usa la funci贸n normal de "Editar" en el inventario</li>
                        <li>Exporta el reporte para enviarlo a tu proveedor</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button class="action-btn btn-cancel">Cerrar</button>
            </div>
        </div>
    </div>
    
    <!-- Notificaci贸n -->
    <div id="notification" class="notification"></div>
    
    <!-- Badge offline -->
    <div id="offlineBadge" class="offline-badge">
         <span id="offlineCount">0</span> venta(s) pendientes
    </div>

    <!-- Nuestro archivo JavaScript principal -->
    <script type="module" src="js/app.js"></script>
</body>
</html>
